From 9579d9b5ffc195f69e4960c03d5a010d055bd274 Mon Sep 17 00:00:00 2001
From: Willy Zhang <willyzhang@google.com>
Date: Tue, 30 Dec 2025 11:30:27 -0800
Subject: [PATCH] Add Bzlmod compatibility and dynamic path resolution

This patch adapts the `crt` toolchain for Bzlmod compatibility in
`opentitan-provisioning`.

1.  Updates `BUILD.bazel` to use the canonical Bzlmod repository name
    `_main~_repo_rules~gcc_mxe_mingw32_files`.
2.  Updates `driver.sh` to dynamically locate the toolchain directory in
    `external/`, ensuring the wrapper works regardless of the specific
    directory structure generated by Bazel/Bzlmod.

Signed-off-by: Willy Zhang <willyzhang@google.com>
---
 toolchains/gcc_mxe_mingw32/BUILD.bazel        | 12 ++++++------
 toolchains/gcc_mxe_mingw32/wrappers/driver.sh | 10 ++++++++++
 2 files changed, 16 insertions(+), 6 deletions(-)
 mode change 100755 => 100644 toolchains/gcc_mxe_mingw32/wrappers/driver.sh

diff --git a/toolchains/gcc_mxe_mingw32/BUILD.bazel b/toolchains/gcc_mxe_mingw32/BUILD.bazel
index ecdd74b..9005a8a 100644
--- a/toolchains/gcc_mxe_mingw32/BUILD.bazel
+++ b/toolchains/gcc_mxe_mingw32/BUILD.bazel
@@ -8,12 +8,12 @@ load("//platforms/x86_32:windows.bzl", "DEVICES")
 package(default_visibility = ["//visibility:public"])
 
 SYSTEM_INCLUDE_PATHS = [
-    "external/gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include",
-    "external/gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include-fixed",
-    "external/gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include/c++",
-    "external/gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include/c++/backward",
-    "external/gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include/c++/i686-w64-mingw32.shared",
-    "external/gcc_mxe_mingw32_files/i686-w64-mingw32.shared/include",
+    "external/_main~_repo_rules~gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include",
+    "external/_main~_repo_rules~gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include-fixed",
+    "external/_main~_repo_rules~gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include/c++",
+    "external/_main~_repo_rules~gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include/c++/backward",
+    "external/_main~_repo_rules~gcc_mxe_mingw32_files/lib/gcc/i686-w64-mingw32.shared/11.3.0/include/c++/i686-w64-mingw32.shared",
+    "external/_main~_repo_rules~gcc_mxe_mingw32_files/i686-w64-mingw32.shared/include",
 ]
 
 filegroup(
diff --git a/toolchains/gcc_mxe_mingw32/wrappers/driver.sh b/toolchains/gcc_mxe_mingw32/wrappers/driver.sh
old mode 100755
new mode 100644
index cfeaaaa..dbb6051
--- a/toolchains/gcc_mxe_mingw32/wrappers/driver.sh
+++ b/toolchains/gcc_mxe_mingw32/wrappers/driver.sh
@@ -6,6 +6,16 @@
 PROG=${0##*/}
 DRIVER_DIR=${0%/*}
 MXE="gcc_mxe_mingw32_files"
+
+# Bzlmod compatibility: Find the actual directory name in external/
+if [ ! -d "external/${MXE}" ]; then
+    # Look for directory ending with ~gcc_mxe_mingw32_files (Bzlmod canonical name style)
+    FOUND=$(find external -maxdepth 1 -name "*~${MXE}" -type d | head -n 1)
+    if [ -n "$FOUND" ]; then
+        MXE=${FOUND#external/}
+    fi
+fi
+
 VERSION="11.3.0"
 PREFIX="i686-w64-mingw32.shared"
 export COMPILER_PATH="external/${MXE}/libexec/gcc/${PREFIX}/${VERSION}:external/${MXE}/bin:${DRIVER_DIR}"
-- 
