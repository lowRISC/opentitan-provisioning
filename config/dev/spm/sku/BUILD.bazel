# Copyright lowRISC contributors (OpenTitan project).
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

load("@rules_pkg//pkg:tar.bzl", "pkg_tar")
load(
    "//rules:hsm.bzl",
    "hsm_config_tar",
    "hsm_key_template",
)
load(
    "//rules:hsmtool.bzl",
    "HSMTOOL_CONST",
    "hsmtool_ecdsa_keygen",
    "hsmtool_pk11_attrs",
    "hsmtool_rsa_keygen",
)

package(default_visibility = ["//visibility:public"])

hsm_key_template(
    name = "spm-rsa-wrap-v0",
    export_public_only = True,
    import_template_public = hsmtool_pk11_attrs({
        "CKA_ENCRYPT": True,
        "CKA_VERIFY": True,
        "CKA_WRAP": True,
        "CKA_TOKEN": True,
    }),
    keygen_params = hsmtool_rsa_keygen(
        extractable = False,
        key_length = 3072,
        label = "spm-rsa-wrap-v0",
        private_template = {
            "CKA_CLASS": "CKO_PRIVATE_KEY",
            "CKA_LABEL": "spm-rsa-unwrap-v0",
            "CKA_DECRYPT": True,
            "CKA_SIGN": True,
            "CKA_TOKEN": True,
            "CKA_SENSITIVE": True,
        },
        public_exponent = 65537,
        public_template = {
            "CKA_CLASS": "CKO_PUBLIC_KEY",
            "CKA_LABEL": "spm-rsa-wrap-v0",
            "CKA_ENCRYPT": True,
            "CKA_VERIFY": True,
            "CKA_TOKEN": True,
        },
        wrapping = True,
    ),
    type = "rsa",
)

hsm_key_template(
    name = "spm-hsm-id-v0",
    export_public_only = True,
    import_template_public = hsmtool_pk11_attrs({
        "CKA_VERIFY": True,
        "CKA_TOKEN": True,
    }),
    keygen_params = hsmtool_ecdsa_keygen(
        # TODO(moidx): Update to P-384 once the hsmtool supports export ops.
        curve = HSMTOOL_CONST.ECC_CURVE.PRIME256V1,
        extractable = False,
        label = "spm-hsm-id-v0",
        private_template = {
            "CKA_LABEL": "spm-hsm-id-v0.priv",
            "CKA_SIGN": True,
            "CKA_TOKEN": True,
            "CKA_EXTRACTABLE": True,
        },
        public_template = {
            "CKA_LABEL": "spm-hsm-id-v0.pub",
            "CKA_VERIFY": True,
            "CKA_TOKEN": True,
        },
        wrapping = False,
    ),
    type = "ecdsa",
)

hsm_config_tar(
    name = "spm_init",
    hsmtool_sequence = {
        ":spm-rsa-wrap-v0": "keygen",
        ":spm-hsm-id-v0": "keygen",
    },
)

hsm_config_tar(
    name = "spm_export",
    hsmtool_sequence = {
        ":spm-rsa-wrap-v0": "export",
        ":spm-hsm-id-v0": "export",
    },
)

pkg_tar(
    name = "release",
    srcs = [
        ":spm_export",
        ":spm_init",
    ],
    extension = "tar.gz",
    include_runfiles = True,
)
